# 数据提取规则配置指南

## 概述

数据提取规则功能用于Modbus TCP协议的数据采集场景，提供灵活的数据提取和转换能力。通过可视化配置界面，用户可以根据实际需求选择不同的数据提取策略。

## 功能特性

### 1. 规则类型

系统提供以下数据提取规则类型：

#### 无提取规则（默认）
- **描述**: 直接使用原始数据，不进行任何转换
- **适用场景**: 数据已经是以正确格式接收，不需要任何处理
- **配置参数**: 无需配置

#### 位提取
- **描述**: 从寄存器值中提取特定的位
- **适用场景**: 需要获取寄存器中的某个状态位或标志位
- **配置参数**:
  - 寄存器索引: 要提取的寄存器位置（从0开始）
  - 起始位: 起始位位置（0-15）
  - 位数: 要提取的位数（1-16）
- **示例**: 从 0xABCD 中提取位 4-7，结果为 0xC (12)

#### 多寄存器组合
- **描述**: 将多个16位寄存器组合成一个32位值
- **适用场景**: 需要读取超过16位的数据（如32位整数、浮点数）
- **配置参数**:
  - 寄存器索引: 要组合的寄存器索引列表（如：0,1）
  - 字节序: 大端序（Motorola）或小端序（Intel）
- **示例**: [0x1234, 0x5678] → 0x12345678（大端序）

#### 数据类型转换
- **描述**: 转换数据类型（INT16/INT32/FLOAT等）
- **适用场景**: 需要将原始数据转换为其他类型进行解释
- **配置参数**:
  - 源数据类型: 原始数据类型
  - 目标数据类型: 转换后的数据类型
  - 字节序: 大端序或小端序
- **支持类型**: INT16, UINT16, INT32, UINT32, FLOAT32, FLOAT64, BOOL, STRING

#### 缩放和偏移
- **描述**: 线性变换：value = raw × scale + offset
- **适用场景**: 传感器数据转换（温度、压力等）
- **配置参数**:
  - 缩放系数: 乘法因子
  - 偏移量: 加法因子
  - 小数位数: 结果保留的小数位数
- **示例**: 温度传感器 250 × 0.1 - 40 = -15.0°C

#### 条件提取
- **描述**: 根据条件选择不同的提取规则
- **适用场景**: 复杂的数据处理场景，需要根据不同条件采用不同处理方式
- **配置参数**:
  - 条件字段: 用于判断的字段名
  - 条件值: 判断值
  - 真值规则: 条件满足时应用的规则
  - 假值规则: 条件不满足时应用的规则

### 2. 预定义模板

系统提供以下预定义规则模板：

| 模板名称 | 规则类型 | 说明 |
|---------|---------|------|
| 温度传感器 | 缩放偏移 | 将原始值转换为温度值（摄氏度），公式：×0.1 - 40 |
| 压力传感器 | 缩放偏移 | 将原始值转换为压力值（MPa），公式：×0.001 |
| 32位整数组合 | 寄存器组合 | 将两个16位寄存器组合成32位整数 |
| 浮点数转换 | 类型转换 | 将寄存器值转换为32位浮点数 |
| 状态位提取 | 位提取 | 提取寄存器的第0位作为状态标志 |

## 使用说明

### 1. 配置数据提取规则

1. 在属性面板中找到"数据提取规则"参数
2. 点击"配置"按钮打开规则配置对话框
3. 选择规则类型
4. 配置相应参数
5. 使用"测试"功能验证规则
6. 点击"确定"保存配置

### 2. 快速选择模板

1. 点击下拉箭头按钮
2. 从菜单中选择预定义模板
3. 系统自动应用模板配置

### 3. 清除规则

1. 点击"清除"按钮
2. 确认清除操作
3. 规则恢复为默认值（无提取规则）

### 4. 测试规则

1. 在"测试输入"框中输入测试值
   - 单个值：直接输入数字（如：250）
   - 多个值：使用逗号分隔（如：100, 200）
   - 列表格式：使用方括号（如：[100, 200]）
2. 点击"测试规则"按钮
3. 查看测试结果

## 界面说明

### 规则配置对话框

```
┌─────────────────────────────────────┐
│         数据提取规则配置             │
├─────────────────────────────────────┤
│ 规则类型: [无提取规则 ▼]            │
│ 描述: 直接使用原始数据...           │
├─────────────────────────────────────┤
│ [参数配置区域 - 根据规则类型变化]    │
├─────────────────────────────────────┤
│ 预定义模板: [选择模板... ▼] [应用]  │
├─────────────────────────────────────┤
│ 规则预览:                           │
│ {                                   │
│   "rule_type": "none",              │
│   ...                               │
│ }                                   │
├─────────────────────────────────────┤
│ 测试输入: [________] [测试规则]     │
│ 测试结果: 测试结果将显示在这里       │
├─────────────────────────────────────┤
│ [重置为默认] [帮助] [取消] [确定]   │
└─────────────────────────────────────┘
```

### 属性面板控件

```
数据提取规则: [无提取规则 - 使用原始数据] [⚙️ 配置] [🗑️] [▼]
```

- **显示区域**: 显示当前配置的规则摘要
- **配置按钮**: 打开规则配置对话框
- **清除按钮**: 清除规则，恢复为默认
- **快速选择**: 下拉菜单，快速选择预定义模板

## 最佳实践

### 1. 选择合适的规则类型

- **简单数据读取**: 使用"无提取规则"
- **状态标志读取**: 使用"位提取"
- **32位数据读取**: 使用"多寄存器组合"
- **传感器数据**: 使用"缩放和偏移"
- **数据类型转换**: 使用"数据类型转换"

### 2. 注意字节序

- **PLC设备**: 通常使用大端序（Motorola格式）
- **PC/嵌入式设备**: 通常使用小端序（Intel格式）
- **不确定时**: 参考设备手册或使用测试功能验证

### 3. 验证规则配置

- 配置完成后使用"测试"功能验证
- 对比预期结果和实际结果
- 如有偏差，检查参数配置（特别是字节序）

### 4. 使用预定义模板

- 常用场景直接使用预定义模板
- 可以基于模板进行修改
- 提高工作效率，减少配置错误

## 故障排除

### 问题1: 提取结果不正确

**可能原因**:
- 字节序选择错误
- 寄存器索引设置错误
- 位位置设置错误

**解决方法**:
1. 检查字节序设置（大端序/小端序）
2. 验证寄存器索引（从0开始）
3. 使用测试功能逐步排查

### 问题2: 规则无法保存

**可能原因**:
- 参数值超出有效范围
- 必填参数未填写

**解决方法**:
1. 检查所有参数是否在有效范围内
2. 确保必填参数已填写
3. 查看错误提示信息

### 问题3: 规则不生效

**可能原因**:
- 规则未启用
- 规则配置错误
- 数据格式不匹配

**解决方法**:
1. 确认规则已启用（enabled=true）
2. 检查规则配置是否正确
3. 验证输入数据格式

## 技术细节

### 数据类型范围

| 数据类型 | 范围 | 说明 |
|---------|------|------|
| INT16 | -32768 ~ 32767 | 有符号16位整数 |
| UINT16 | 0 ~ 65535 | 无符号16位整数 |
| INT32 | -2147483648 ~ 2147483647 | 有符号32位整数 |
| UINT32 | 0 ~ 4294967295 | 无符号32位整数 |
| FLOAT32 | ±3.4E±38 | 32位浮点数（单精度） |
| FLOAT64 | ±1.7E±308 | 64位浮点数（双精度） |

### 字节序说明

**大端序（Big Endian）**:
- 高位字节存储在低地址
- 也称为：Motorola格式、网络字节序
- 示例：0x12345678 存储为 [0x12, 0x34, 0x56, 0x78]

**小端序（Little Endian）**:
- 低位字节存储在低地址
- 也称为：Intel格式
- 示例：0x12345678 存储为 [0x78, 0x56, 0x34, 0x12]

## 相关文件

- `tools/communication/data_extraction_rules.py` - 数据提取规则核心实现
- `ui/data_extraction_rule_dialog.py` - 规则配置对话框
- `ui/widgets/extraction_rule_widget.py` - 属性面板控件
- `ui/property_panel.py` - 属性面板集成

## 更新日志

### 2026-02-05
- 初始版本发布
- 支持7种数据提取规则类型
- 提供5个预定义模板
- 集成到属性面板
- 添加完整的帮助文档
