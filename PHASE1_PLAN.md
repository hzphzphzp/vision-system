# 第一阶段执行计划

## 目标
让项目达到生产级标准，包括完善的测试、修复稳定性问题、完善文档。

## 时间线：2-3 周

---

## 任务 1：修复测试运行问题（第 1-2 天）

### 1.1 识别并修复测试导入问题
- **问题**：运行 pytest 时发生访问违规，可能是 GUI 模块初始化问题
- **方案**：
  - 分离 GUI 测试和非 GUI 测试
  - 使用 pytest markers 标记 GUI 测试
  - 添加命令行选项控制是否运行 GUI 测试

### 1.2 创建测试分类
```
tests/
├── unit/           # 单元测试（无 GUI）
├── integration/    # 集成测试（无 GUI）
├── ui/            # UI 测试（需要 GUI）
└── e2e/           # 端到端测试
```

### 1.3 修复 conftest.py
- 添加 GUI 检测逻辑
- 添加自动跳过 GUI 测试的机制

---

## 任务 2：完善核心模块测试（第 3-5 天）

### 2.1 核心模块测试覆盖率目标：80%+

**需要测试的模块**：
- [ ] `core/tool_base.py` - 工具基类
- [ ] `core/procedure.py` - 流程管理
- [ ] `core/solution.py` - 方案管理
- [ ] `core/pipeline.py` - 流水线执行
- [ ] `data/image_data.py` - 图像数据
- [ ] `data/result_data.py` - 结果数据

### 2.2 测试场景清单
- [ ] 工具参数验证（边界值、异常值）
- [ ] 流程拓扑排序（复杂依赖图）
- [ ] 方案序列化和反序列化
- [ ] 错误处理和恢复

---

## 任务 3：修复稳定性问题（第 6-10 天）

### 3.1 线程安全问题（优先级：高）

**需要修复的文件**：
- [ ] `core/communication/tcp_server.py` - 心跳线程清理 ✅ 已修复
- [ ] `ui/main_window.py` - QTimer 信号断开 ✅ 已修复
- [ ] `modules/camera/camera_manager.py` - 相机资源释放 ✅ 已修复

**待修复**：
- [ ] 所有使用 QTimer 的地方添加信号断开
- [ ] 检查所有后台线程是否正确清理
- [ ] 添加线程安全检查装饰器

### 3.2 内存泄漏修复（优先级：高）

**已修复**：
- [ ] 回调列表无限增长 ✅
- [ ] 图像缓存无限增长 ✅
- [ ] 结果面板无限制 ✅

**待修复**：
- [ ] 检查所有使用 `__del__` 的地方
- [ ] 确保 Qt 对象正确父子关系
- [ ] 添加内存使用监控

### 3.3 资源管理规范化
- [ ] 统一资源释放接口
- [ ] 添加上下文管理器支持
- [ ] 创建资源监控工具

---

## 任务 4：完善文档和注释（第 11-14 天）

### 4.1 API 文档
- [ ] 为核心类添加 Google 风格 docstring
- [ ] 生成 Sphinx 文档
- [ ] 添加使用示例

### 4.2 架构文档
- [ ] 系统架构图
- [ ] 数据流图
- [ ] 模块依赖图

### 4.3 开发者文档
- [ ] 如何添加新工具
- [ ] 如何添加新通讯协议
- [ ] 调试指南

### 4.4 代码注释规范
- [ ] 复杂算法添加详细注释
- [ ] 关键配置项说明
- [ ] 已知问题和限制说明

---

## 任务 5：代码质量提升（第 15-17 天）

### 5.1 静态代码检查
- [ ] 配置 flake8 规则
- [ ] 配置 mypy 类型检查
- [ ] 添加 pylint 检查
- [ ] 修复所有警告

### 5.2 类型注解完善
- [ ] 为核心模块添加类型注解
- [ ] 为工具模块添加类型注解
- [ ] 为数据模块添加类型注解

### 5.3 配置管理优化
- [ ] 使用 Pydantic 验证配置
- [ ] 统一配置文件格式
- [ ] 添加配置文档

---

## 任务 6：CI/CD 和自动化（第 18-21 天）

### 6.1 自动化测试
- [ ] 配置 GitHub Actions 或 GitLab CI
- [ ] 自动运行单元测试
- [ ] 生成测试覆盖率报告
- [ ] 自动代码质量检查

### 6.2 发布流程
- [ ] 创建 release 脚本
- [ ] 自动打包和发布
- [ ] 版本号管理

---

## 验收标准

### 测试相关
- [ ] 所有单元测试通过
- [ ] 测试覆盖率 ≥ 70%
- [ ] CI/CD 流程正常运行

### 稳定性相关
- [ ] 运行 24 小时无内存泄漏
- [ ] 线程无异常退出
- [ ] 资源正确释放

### 文档相关
- [ ] 所有公共 API 有 docstring
- [ ] 架构文档完整
- [ ] 开发者指南可用

---

## 风险和对策

| 风险 | 概率 | 影响 | 对策 |
|------|------|------|------|
| GUI 测试难以自动化 | 高 | 中 | 分离 GUI 和非 GUI 测试 |
| 旧代码重构引入 Bug | 中 | 高 | 小步快跑，充分测试 |
| 文档编写耗时 | 高 | 低 | 使用工具自动生成部分文档 |
| 内存泄漏难以定位 | 中 | 中 | 使用专业工具（tracemalloc） |

---

## 下一步行动

1. **立即开始**：修复测试导入问题，让 pytest 能正常运行
2. **本周内**：完成核心模块的单元测试
3. **下周**：修复所有已知的稳定性问题
4. **第三周**：完善文档和自动化

---

**开始执行？** 请输入 "开始任务 X" 来启动具体任务。
